<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>× ×—×© ××ª ×”×©×™×¨ â€¢ ××©×—×§</title>
<style>
  :root{
    --bg1:#ffdde1; --bg2:#ee9ca7; --card:#fff; --ink:#222; --muted:#6b7280;
    --btn:#ffd166; --btn2:#8ecae6; --ok:#16a34a; --bad:#ef4444; --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; background:linear-gradient(135deg,var(--bg1),var(--bg2));
    font-family:system-ui,Segoe UI,Heebo,Roboto,sans-serif; color:var(--ink);
    display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{ width:min(960px,100%); background:rgba(255,255,255,.92); border-radius:var(--r); box-shadow:0 10px 30px rgba(0,0,0,.15); overflow:hidden }
  header{ display:flex; justify-content:space-between; align-items:center; padding:14px 16px; background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.2)) }
  h1{ margin:0; font-size:20px }
  .pill{ font-size:12px; background:#eef2ff; color:#1b3b9b; padding:4px 8px; border-radius:999px }
  .top-row{ display:grid; grid-template-columns: 160px 1fr; gap:12px; padding:0 16px 12px }
  .album{
    position:relative; border-radius:16px; overflow:hidden; height:160px; background:#ddd; display:grid; place-items:center
  }
  .album img{ width:100%; height:100%; object-fit:cover; display:block; filter: blur(6px); transition:.25s ease }
  .album.unblur img{ filter: blur(0) }
  .meta{ display:flex; gap:10px; align-items:center; justify-content:space-between; background:#fff; border:1px dashed #d1d5db; border-radius:14px; padding:10px 12px }
  .meta .title{ font-weight:800 }
  .meta .blurred{ filter: blur(5px); transition:.25s ease }
  .game{ background:#fff; border-top:1px solid #eee; padding:16px }
  .hints{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:6px }
  .hint{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; min-height:56px; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; transition:.2s ease }
  .hint.revealed{ background:#fff }
  .hint .idx{ color:var(--muted); font-size:12px }
  .hint .txt{ flex:1; margin:0 10px }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px }
  input[type="text"]{ flex:1 1 280px; padding:12px 14px; border:1px solid #d1d5db; border-radius:12px; font-size:16px }
  button{ border:0; border-radius:12px; padding:12px 14px; font-size:16px; cursor:pointer; transition:.2s ease; background:var(--btn) }
  button.secondary{ background:#e5e7eb } button.info{ background:var(--btn2) }
  button.ok{ background:#86efac } button.danger{ background:#fecaca }
  button:disabled{ opacity:.6; cursor:not-allowed }
  .status{ margin-top:10px; font-weight:700; text-align:center }
  .status.ok{ color:var(--ok) } .status.bad{ color:var(--bad) }
  footer{ display:flex; justify-content:space-between; align-items:center; padding:10px 16px; color:#374151; font-size:12px }
  /* flip */
  .flip{ animation:flip .6s ease both; transform-origin:center }
  @keyframes flip{ 0%{transform:rotateX(0);opacity:1} 50%{transform:rotateX(90deg);opacity:0} 51%{opacity:0} 100%{transform:rotateX(0);opacity:1} }
  @media (max-width:720px){ .top-row{ grid-template-columns:120px 1fr } .album{ height:120px } }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>ğŸµ × ×—×© ××ª ×”×©×™×¨ â€” ××©×—×§</h1>
    <div class="pill" id="userPill">××•×¨×—</div>
  </header>

  <div class="top-row">
    <div class="album" id="albumCard"><img id="albumImg" alt="Album Art"></div>
    <div class="meta">
      <div class="title"><span id="metaArtist" class="blurred">×××Ÿ</span> â€¢ <span id="metaYear" class="blurred">×©× ×”</span></div>
      <button id="btnMeta" class="info" title="×—×©×•×£ ×××Ÿ+×©× ×”">ğŸ” ×¨××–: ×××Ÿ+×©× ×”</button>
    </div>
  </div>

  <section class="game">
    <div id="hints" class="hints"></div>
    <div class="controls">
      <input id="guess" placeholder="×©× ×”×©×™×¨â€¦" autocomplete="off">
      <button id="btnGuess">× ×—×©</button>
      <button id="btnReveal">×¢×•×“ ×¨××–</button>
      <button id="btnNext" class="secondary">×©×™×¨ ×”×‘×</button>
    </div>
    <div id="status" class="status"></div>
  </section>

  <footer>
    <div id="progress">×©×™×¨ 1 / 1 â€¢ ×¨××–×™×: 1/4</div>
    <a href="index.html" class="pill" style="text-decoration:none">â¬… ×—×–×¨×” ×œ×©×œ×‘×™×</a>
  </footer>
</div>

<script>
const LS_PROGRESS_PREFIX = 'gts_progress_';
const $ = s=>document.querySelector(s);
const qs = new URLSearchParams(location.search);
const levelId = qs.get('level') || '';
const configFile = qs.get('file') || '';
const user = qs.get('user') || '××•×¨×—';

const hintsEl = $('#hints'), guessEl = $('#guess'), statusEl = $('#status');
const btnGuess = $('#btnGuess'), btnReveal = $('#btnReveal'), btnNext = $('#btnNext'), btnMeta = $('#btnMeta');
const albumCard = $('#albumCard'), albumImg = $('#albumImg'), metaArtist = $('#metaArtist'), metaYear = $('#metaYear');
const userPill = $('#userPill'), progressEl = $('#progress');

let SONGS = [];     // ××ª×•×š ×”×§×•× ×¤×™×’
let i = 0;          // ××™× ×“×§×¡ ×©×™×¨
let revealed = 1;   // ××ª×—×™×œ×™× ×¢× ×©×•×¨×” ×¨××©×•× ×” ×’×œ×•×™×”
let metaRevealed = false;
let endedSong = false;

userPill.textContent = user || '××•×¨×—';

function norm(s){ return (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^\p{L}\p{N}]+/gu,''); }
function current(){ return SONGS[i]; }
function progressKey(u){ return LS_PROGRESS_PREFIX + (u||'guest'); }
function getProgress(u){ try{ return JSON.parse(localStorage.getItem(progressKey(u))||'{}'); }catch(e){ return {}; } }
function setProgress(u,obj){ localStorage.setItem(progressKey(u), JSON.stringify(obj)); }

async function fetchJSON(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('Fetch failed: '+url);
  return res.json();
}
async function loadConfig(){
  if(configFile){ return await fetchJSON(configFile); }
  const m = await fetchJSON('configs/manifest.json');
  const lv = m.levels.find(x=>x.id===levelId);
  if(!lv) throw new Error('Level not found in manifest');
  return await fetchJSON(lv.file);
}

function lineBox(idx, text, revealedNow){
  const div = document.createElement('div');
  div.className = 'hint' + (revealedNow ? ' revealed':'');

  const left = document.createElement('span');
  left.className = 'idx';
  left.textContent = `×©×•×¨×” ${idx+1}`;

  const mid = document.createElement('div');
  mid.className = 'txt';
  mid.textContent = revealedNow ? text : '???';

  div.append(left, mid);
  return div;
}

function updateProgressBar(){
  progressEl.textContent = `×©×™×¨ ${i+1} / ${SONGS.length} â€¢ ×¨××–×™×: ${Math.min(revealed,4)}/4`;
}

function renderSong(){
  const s = current();
  statusEl.textContent = '';
  endedSong = false;
  metaRevealed = false;
  revealed = 1; // ×©×•×¨×” 1 ××”×ª×—×œ×”

  // ×ª××•× ×ª ××œ×‘×•× ×•×××Ÿ/×©× ×” (××˜×•×©×˜×©×™× ×¢×“ ×¨××–)
  albumImg.src = s.albumArt || '';
  albumCard.classList.remove('unblur'); // blur ON
  metaArtist.textContent = s.artist || 'â€”';
  metaYear.textContent = s.year || 'â€”';
  metaArtist.classList.add('blurred');
  metaYear.classList.add('blurred');

  btnMeta.disabled = false;
  btnReveal.disabled = false;
  btnGuess.disabled = false;
  guessEl.disabled = false;
  btnReveal.textContent = '×¢×•×“ ×¨××–';

  // ××¦×™×’×™× ×ª××™×“ ×ª×¨×’×•× ×”×¤×•×š
  const show = s.linesTranslated;
  hintsEl.innerHTML = '';
  for(let k=0;k<4;k++){
    hintsEl.appendChild(lineBox(k, show[k], k < revealed)); // ×¨×§ ×”×¨××©×•× ×” ×’×œ×•×™×”
  }

  updateProgressBar();
  guessEl.value='';
  guessEl.focus();
}

function revealOne(){
  if(endedSong) return;
  if(revealed >= 4) return; // ×›×œ 4 ×”×©×•×¨×•×ª ×›×‘×¨ ×’×œ×•×™×•×ª
  revealed++; // ×¤×•×ª×— ×‘×“×™×•×§ ×©×•×¨×” ××—×ª ×‘×›×œ ×¤×¢×
  const s = current();
  const show = s.linesTranslated;
  for(let k=0;k<4;k++){
    const box = hintsEl.children[k];
    const txt = box.querySelector('.txt');
    const vis = (k < revealed);
    box.classList.toggle('revealed', vis);
    txt.textContent = vis ? show[k] : '???';
  }
  updateProgressBar();
}

function revealMeta(){
  if(metaRevealed) return;
  metaRevealed = true;
  albumCard.classList.add('unblur');
  metaArtist.classList.remove('blurred');
  metaYear.classList.remove('blurred');
  statusEl.className='status';
  statusEl.textContent='× ×¤×ª×— ×¨××– ×××Ÿ+×©× ×”.';
}

function flipToOriginal(){
  const s = current();
  const orig = s.linesOriginal;
  for(let k=0;k<4;k++){
    const box = hintsEl.children[k];
    const txt = box.querySelector('.txt');
    txt.classList.add('flip');
    setTimeout(()=>{ txt.textContent = orig[k]; }, 280);
    setTimeout(()=>{ txt.classList.remove('flip'); }, 650);
  }
}

function onGuess(){
  if(endedSong) return;
  const s = current();
  const val = guessEl.value.trim();
  if(!val) return;
  const g = norm(val);
  const candidates = [s.title, ...(s.altTitles||[])].map(norm);
  const ok = candidates.includes(g);

  if(ok){
    endSong(true, `âœ… × ×›×•×Ÿ! â€œ${s.title}â€`);
  }else{
    // ×©×’×•×™ â†’ ×× ×¢×•×“ ×œ× ×—×•×©×¤×• ×›×œ ×”×©×•×¨×•×ª, ×¤×•×ª×—×™× ×¢×•×“ ×©×•×¨×”; ×× ×”×›×œ ×›×‘×¨ ×’×œ×•×™â€”×¨×§ ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
    if(revealed < 4){ revealOne(); statusEl.className='status'; statusEl.textContent='×œ× × ×›×•×Ÿ â€” × ×¤×ª×—×” ×©×•×¨×” × ×•×¡×¤×ª.'; }
    else { statusEl.className='status'; statusEl.textContent='×œ× × ×›×•×Ÿ. ××¤×©×¨ ×œ×”×©×ª××© ×‘×¨××– ×××Ÿ+×©× ×” ××• ×œ×¢×‘×•×¨ ×”×œ××”.'; }
  }
}

function endSong(win, msg){
  endedSong = true;
  statusEl.textContent = msg;
  statusEl.className = 'status ' + (win ? 'ok' : 'bad');
  btnGuess.disabled = true;
  guessEl.disabled = true;
  // ××¤×§×˜ ×”×™×¤×•×š ×˜×§×¡×˜ ×œ×ª×¨×’×•× ×”×”×¤×•×š (×œ××§×•×¨)
  flipToOriginal();

  // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×œ×©×œ×‘
  const u = user || 'guest';
  const pk = progressKey(u);
  const prog = getProgress(u);
  const obj = prog[levelId] || {played:0, won:0};
  obj.played = (obj.played||0) + 1;
  if(win) obj.won = (obj.won||0) + 1;
  prog[levelId] = obj;
  setProgress(u, prog);
}

function nextSong(){
  if(i < SONGS.length-1){
    i++;
    renderSong();
  }else{
    alert('×”×’×¢×ª ×œ×¡×•×£ ×”×©×œ×‘! ×—×•×–×¨×™× ×œ××¡×š ×”×©×œ×‘×™×.');
    location.href = 'index.html';
  }
}

btnReveal.addEventListener('click', revealOne);
btnMeta.addEventListener('click', revealMeta);
btnGuess.addEventListener('click', onGuess);
guessEl.addEventListener('keydown', e=>{ if(e.key==='Enter') onGuess(); });
btnNext.addEventListener('click', nextSong);

(async function init(){
  try{
    const cfg = await loadConfig();
    SONGS = cfg.songs || [];
    if(!SONGS.length) throw new Error('No songs in config');
    i = 0;
    renderSong();
  }catch(err){
    console.error(err);
    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•× ×¤×™×’×•×¨×¦×™×”. ×‘×“×•×§/×™ ××ª ×”××¡××›×™× ×ª×—×ª configs/.');
    location.href = 'index.html';
  }
})();
</script>
</body>
</html>