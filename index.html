<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>× ×—×© ××ª ×”×©×™×¨ â€¢ ×©×œ×‘×™×</title>
<style>
  :root{--bg:#fff8dc;--ink:#222;--muted:#6b7280;--card:#fff;--acc:#6c8cff;--ok:#1fa37d;--bad:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,Segoe UI,Heebo,Roboto,sans-serif;color:var(--ink)}
  .wrap{max-width:920px;margin:0 auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;gap:10px}
  h1{margin:0;font-size:24px}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button{font-size:16px;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db}
  button{background:var(--acc);color:#fff;border:0;cursor:pointer}
  button.secondary{background:#eef}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
  .level{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:10px}
  .level h3{margin:0;font-size:18px}
  .pill{font-size:12px;background:#eef2ff;color:#1b3b9b;padding:4px 8px;border-radius:999px}
  .stat{display:flex;align-items:center;gap:8px;color:var(--muted)}
  .stat .dot{width:10px;height:10px;border-radius:50%;background:#d1d5db}
  .stat.done .dot{background:var(--ok)}
  .stat.todo .dot{background:#d1d5db}
  .top{display:flex;justify-content:space-between;align-items:center}
  .hint{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ğŸµ × ×—×© ××ª ×”×©×™×¨ â€” ×©×œ×‘×™×</h1>
    <div id="userBox" class="row">
      <input id="username" placeholder="×©× ××©×ª××©..." autocomplete="off">
      <button id="btnLogin">×›× ×™×¡×”</button>
      <span id="hello" class="pill" style="display:none"></span>
      <button id="btnLogout" class="secondary" style="display:none">×”×ª× ×ª×§/×™</button>
    </div>
  </header>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="hint">×‘×—×¨/×™ ×©×œ×‘. ×”×¡×˜×˜×•×¡ × ×©××¨ ×¤×¨Ö¾××©×ª××© ×‘×“×¤×“×¤×Ÿ.</div>
      <span class="pill">×§×•× ×¤×™×’×™× × ×˜×¢× ×™× ×Ö¾configs/manifest.json</span>
    </div>
    <div id="levels" class="grid" aria-live="polite"></div>
  </div>
</div>

<script>
const LS_USER_KEY = 'gts_user';
const LS_PROGRESS_PREFIX = 'gts_progress_'; // ×œ×›×œ ××©×ª××©

const $ = sel => document.querySelector(sel);
const usernameEl = $('#username');
const helloEl = $('#hello');
const btnLogin = $('#btnLogin');
const btnLogout = $('#btnLogout');
const levelsEl = $('#levels');

function getUser(){
  return localStorage.getItem(LS_USER_KEY) || '';
}
function setUser(u){
  if(u) localStorage.setItem(LS_USER_KEY, u); else localStorage.removeItem(LS_USER_KEY);
  syncUserUI();
}
function progressKey(u){ return LS_PROGRESS_PREFIX + u; }
function getProgress(u){
  try{ return JSON.parse(localStorage.getItem(progressKey(u)) || '{}'); }catch(e){ return {}; }
}
function setProgress(u, obj){
  localStorage.setItem(progressKey(u), JSON.stringify(obj));
}

function syncUserUI(){
  const u = getUser();
  if(u){
    usernameEl.style.display='none';
    btnLogin.style.display='none';
    helloEl.style.display='inline-block';
    helloEl.textContent = `×©×œ×•×, ${u}`;
    btnLogout.style.display='inline-block';
  }else{
    usernameEl.style.display='inline-block';
    btnLogin.style.display='inline-block';
    helloEl.style.display='none';
    btnLogout.style.display='none';
  }
  renderLevels(); // ×›×“×™ ×œ×¦×‘×•×¢ DONE/TO-DO
}

btnLogin.addEventListener('click', ()=>{
  const u = usernameEl.value.trim();
  if(!u) return alert('× × ×œ×”×–×™×Ÿ ×©× ××©×ª××©');
  setUser(u);
});
btnLogout.addEventListener('click', ()=>{ setUser(''); });

async function fetchJSON(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('Fetch failed: '+url);
  return res.json();
}

async function loadManifest(){
  // ××ª×” ××•×¡×™×£ ×§×‘×¦×™× ×œ-configs/ ×•××¢×“×›×Ÿ manifest.json
  const m = await fetchJSON('configs/manifest.json');
  if(!m || !Array.isArray(m.levels)) throw new Error('manifest.json must have { levels: [...] }');
  return m.levels;
}

function levelCard(lv, done){
  const div = document.createElement('div');
  div.className='level';
  const top = document.createElement('div');
  top.className='top';
  const h = document.createElement('h3');
  h.textContent = lv.title;
  const right = document.createElement('div');
  right.innerHTML = `<span class="pill">${lv.id}</span>`;
  top.append(h, right);

  const stat = document.createElement('div');
  stat.className = 'stat ' + (done ? 'done' : 'todo');
  stat.innerHTML = `<span class="dot"></span><span>${done ? '×”×•×©×œ×' : '×˜×¨× ×”×•×©×œ×'}</span>`;

  const btn = document.createElement('button');
  btn.textContent = '×©×—×§/×™';
  btn.addEventListener('click', ()=>{
    const u = getUser() || '';
    const qs = new URLSearchParams({level: lv.id, file: lv.file, user: u});
    location.href = `game.html?${qs.toString()}`;
  });

  div.append(top, stat, btn);
  return div;
}

async function renderLevels(){
  levelsEl.innerHTML = '×˜×•×¢×Ÿ...';
  try{
    const levels = await loadManifest();
    levelsEl.innerHTML = '';
    const u = getUser() || '';
    const prog = getProgress(u);
    levels.forEach(lv=>{
      const done = !!prog?.[lv.id];
      levelsEl.appendChild(levelCard(lv, done));
    });
  }catch(err){
    console.error(err);
    levelsEl.innerHTML = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×©×œ×‘×™×. ×•×“× ×©×§×™×™× configs/manifest.json ×ª×§×™×Ÿ.';
  }
}

// init
(function init(){
  const u = getUser();
  if(u){ usernameEl.value = u; }
  syncUserUI();
})();
</script>
</body>
</html>